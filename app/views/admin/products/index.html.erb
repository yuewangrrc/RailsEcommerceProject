<% content_for :title, "Manage Products" %>

<div class="d-flex justify-content-between align-items-center mb-4">
  <h1>
    <i class="fas fa-boxes me-2"></i>Manage Products 
    <span class="badge bg-secondary"><%= @products.total_count %></span>
  </h1>
  <%= link_to "Add New Product", new_admin_product_path, class: "btn btn-primary" %>
</div>

<!-- Advanced Filtering Form -->
<div class="card mb-4">
  <div class="card-header">
    <h5 class="mb-0">
      <i class="fas fa-filter me-2"></i>Product Filters
    </h5>
  </div>
  <div class="card-body">
    <%= form_with url: admin_products_path, method: :get, local: true, class: "row g-3" do |f| %>
      <div class="col-md-4">
        <%= f.text_field :search, value: params[:search], placeholder: "Search products...", 
            class: "form-control", id: "product-search" %>
      </div>
      <div class="col-md-3">
        <%= f.collection_select :category_id, @categories, :id, :name, 
            { prompt: "All Categories", selected: params[:category_id] }, 
            { class: "form-select" } %>
      </div>
      <div class="col-md-2">
        <%= f.select :stock_filter, 
            options_for_select([
              ['All Stock Levels', ''],
              ['In Stock', 'in_stock'],
              ['Out of Stock', 'out_of_stock'],
              ['Low Stock (â‰¤5)', 'low_stock']
            ], params[:stock_filter]), 
            {}, { class: "form-select" } %>
      </div>
      <div class="col-md-3">
        <div class="d-flex gap-2">
          <%= f.submit "Filter", class: "btn btn-outline-primary" %>
          <%= link_to "Reset", admin_products_path, class: "btn btn-outline-secondary" %>
        </div>
      </div>
    <% end %>
  </div>
</div>

<!-- Products Table -->
<div class="card">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h5 class="mb-0">Products List</h5>
  </div>
  <div class="card-body p-0">
    <div class="table-responsive">
      <table class="table table-striped mb-0">
        <thead class="table-dark">
          <tr>
            <th style="width: 80px;">Image</th>
            <th>Product</th>
            <th>Category</th>
            <th>Price</th>
            <th>Stock</th>
            <th>Status</th>
            <th style="width: 120px;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% if @products.any? %>
            <% @products.each do |product| %>
              <tr>
                <td>
                  <img src="<%= product.image_url %>" alt="<%= product.name %>" 
                       style="width: 50px; height: 50px; object-fit: cover;" class="rounded">
                </td>
                <td>
                  <div>
                    <strong><%= link_to product.name, admin_product_path(product), 
                        class: "text-decoration-none" %></strong>
                    <br>
                    <small class="text-muted">Size: <%= product.size %></small>
                  </div>
                </td>
                <td>
                  <span class="badge bg-info"><%= product.category.name %></span>
                </td>
                <td>
                  <strong>$<%= product.price %></strong>
                </td>
                <td>
                  <span class="badge bg-<%= product.stock_status_class %>">
                    <%= product.stock_status %> (<%= product.stock %>)
                  </span>
                </td>
                <td>
                  <% if product.active? %>
                    <span class="badge bg-success">Active</span>
                  <% else %>
                    <span class="badge bg-secondary">Inactive</span>
                  <% end %>
                </td>
                <td>
                  <div class="btn-group btn-group-sm">
                    <%= link_to admin_product_path(product), class: "btn btn-outline-primary btn-sm" do %>
                      <i class="fas fa-eye"></i>
                    <% end %>
                    <%= link_to edit_admin_product_path(product), class: "btn btn-outline-warning btn-sm" do %>
                      <i class="fas fa-edit"></i>
                    <% end %>
                    <%= link_to admin_product_path(product),
                        class: "btn btn-outline-danger btn-sm",
                        data: { 
                          turbo_method: :delete,
                          turbo_confirm: "Are you sure you want to delete #{product.name}?" 
                        } do %>
                      <i class="fas fa-trash"></i>
                    <% end %>
                  </div>
                </td>
              </tr>
            <% end %>
          <% else %>
            <tr>
              <td colspan="7" class="text-center py-5">
                <div class="text-muted">
                  <i class="fas fa-box-open fa-3x mb-3"></i>
                  <h5>No products found</h5>
                  <p>Try adjusting your search criteria or <%= link_to "add a new product", new_admin_product_path %>.</p>
                </div>
              </td>
            </tr>
          <% end %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Pagination -->
<% if @products.respond_to?(:total_pages) && @products.total_pages > 1 %>
  <div class="d-flex justify-content-center mt-4">
    <nav aria-label="Products pagination">
      <ul class="pagination">
        <% if @products.prev_page %>
          <li class="page-item">
            <%= link_to "Previous", admin_products_path(page: @products.prev_page, search: params[:search], 
                category_id: params[:category_id], stock_filter: params[:stock_filter]), 
                class: "page-link" %>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Previous</span>
          </li>
        <% end %>

        <% (1..@products.total_pages).each do |page| %>
          <% if page == @products.current_page %>
            <li class="page-item active">
              <span class="page-link"><%= page %></span>
            </li>
          <% elsif (page - @products.current_page).abs <= 2 || page == 1 || page == @products.total_pages %>
            <li class="page-item">
              <%= link_to page, admin_products_path(page: page, search: params[:search], 
                  category_id: params[:category_id], stock_filter: params[:stock_filter]), 
                  class: "page-link" %>
            </li>
          <% elsif (page - @products.current_page).abs == 3 %>
            <li class="page-item disabled">
              <span class="page-link">...</span>
            </li>
          <% end %>
        <% end %>

        <% if @products.next_page %>
          <li class="page-item">
            <%= link_to "Next", admin_products_path(page: @products.next_page, search: params[:search], 
                category_id: params[:category_id], stock_filter: params[:stock_filter]), 
                class: "page-link" %>
          </li>
        <% else %>
          <li class="page-item disabled">
            <span class="page-link">Next</span>
          </li>
        <% end %>
      </ul>
    </nav>
  </div>
<% end %>
